---
import Layout from "../../layouts/Layout.astro";
import Card from "../../components/Card/index.astro";
import { formatDate } from "../../lib/helpers";

const works = await Astro.glob('/src/content/work/*.md');

// Asegurarse de que cada trabajo tenga un slug y mantener la propiedad image
const worksWithSlugs = works.map(work => {
  return {
    ...work,
    frontmatter: {
      ...work.frontmatter,
      title: work.frontmatter.title || 'Untitled',
      description: work.frontmatter.description || '',
      pubDate: work.frontmatter.pubDate || new Date(),
      slug: work.frontmatter.slug || work.file.split('/').pop()?.replace('.md', ''),
      image: work.frontmatter.image // Asegurarse de que image se incluya explícitamente
    }
  };
});
---

<script>
  import { timeline, type TimelineDefinition } from "motion";
  import { loaderAnimation } from "../../lib/constants";

  const sequence = [loaderAnimation];
  timeline(sequence as TimelineDefinition);
</script>

<Layout title="Andres Mesa - Artwork" description="Creative coder">
  <main class="w-screen min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
      <a href="../" class="text-white bg-neutral-900 hover:bg-neutral-800 px-4 py-2 mb-8 border-0 border-solid border-white rounded-none inline-block">
        Back
      </a>
      <h1 class="text-4xl font-bold mb-8 text-neutral-100">ARTWORK</h1>
      
      {/* Para depuración: mostrar los datos disponibles */}
      <div class="hidden">
        {works.map(work => (
          <pre>{JSON.stringify(work.frontmatter, null, 2)}</pre>
        ))}
      </div>
      
      <ul class="grid grid-cols-1 md:grid-cols-2 gap-8">
        {works.map((work) => {
          // Construir una ruta absoluta para la imagen
          const imagePath = work.frontmatter.image ? 
            (work.frontmatter.image.startsWith('/') ? 
              work.frontmatter.image : 
              `/${work.frontmatter.image}`) : 
            null;
          
          return (
            <li class="w-full">
              <Card>
                <a href={`/artwork/${work.frontmatter.slug || work.file.split('/').pop()?.replace('.md', '')}`} class="block text-neutral-100 hover:text-neutral-400">
                  <div class="flex flex-col gap-2">
                    <h3 class="font-bold m-0 pt-0 mb-0">{work.frontmatter.title}</h3>
                    <p class="my-0 font-light text-sm">{work.frontmatter.description}</p>
                    
                    {/* Insertar algunas imágenes conocidas para probar */}
                    <img 
                      src="/rd-td.gif"
                      alt="Test image 1"
                      class="w-full h-auto max-h-[150px] select-none pointer-events-none"
                    />
                    
                    {/* Intentar mostrar la imagen real con ruta forzada */}
                    {imagePath && (
                      <img 
                        src={imagePath}
                        alt={work.frontmatter.title}
                        class="w-full h-auto max-h-[300px] select-none md:w-auto md:max-h-[300px] md:relative md:opacity-100 pointer-events-none"
                      />
                    )}
                    
                    {/* Mostrar la ruta original de la imagen para depuración */}
                    <div class="text-xs text-gray-500">
                      <p>Ruta original: {work.frontmatter.image}</p>
                      <p>Ruta procesada: {imagePath}</p>
                    </div>
                    
                    {work.frontmatter.pubDate && (
                      <time
                        class="text-right tabular-nums text-sm text-neutral-400"
                        datetime={new Date(work.frontmatter.pubDate).toISOString()} 
                      >
                        {formatDate(new Date(work.frontmatter.pubDate))}
                      </time>
                    )}
                  </div>
                </a>
              </Card>
            </li>
          );
        })}
      </ul>
    </div>
  </main>
</Layout>
